<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì£¼ê°„ ê±°ë˜ ë°ì´í„° ì¡°íšŒ</title>
</head>
<body>
  <h2>ğŸ“Š ì£¼ê°„ ê±°ë˜ ë°ì´í„° ì¡°íšŒ</h2>

  <form id="filter-form">
    <label>í’ˆëª©:
      <select id="item-select" name="item_code" required></select>
    </label>

    <label>í’ˆì¢…:
      <select id="variety-select" name="crop_full_code">
        <option value="">ì „ì²´</option>
      </select>
    </label>

    <label>ë“±ê¸‰:
      <select id="grade-select" name="grade">
        <option value="">ì „ì²´</option>
        <option value="ê³ ">ê³ </option>
        <option value="ì¤‘">ì¤‘</option>
        <option value="ì €">ì €</option>
      </select>
    </label>

    <label>ì‚°ì§€:
      <select id="sanji-select" name="sanji_cd">
        <option value="">ì „ì²´</option>
      </select>
    </label>

    <label>ì‹œì‘ ì£¼ì°¨:
      <input type="text" id="start-week" name="start_week" placeholder="ì˜ˆ: 202410" required>
    </label>
    <label>ì¢…ë£Œ ì£¼ì°¨:
      <input type="text" id="end-week" name="end_week" placeholder="ì˜ˆ: 202423" required>
    </label>

    <button type="submit">ì¡°íšŒ</button>
  </form>

  <hr>

  <table border="1" id="result-table">
    <thead>
      <tr>
        <th>ì£¼ì°¨</th><th>í’ˆëª©</th><th>í’ˆì¢…</th><th>ë“±ê¸‰</th><th>ì‚°ì§€</th><th>ê±°ë˜ëŸ‰(kg)</th><th>í‰ê· ë‹¨ê°€(ì›)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

    <script>
    // í’ˆëª© ë“œë¡­ë‹¤ìš´ (ì´ì „ ì„ íƒê°’ ìœ ì§€)
    async function fetchItems() {
      const select = document.getElementById('item-select');
      const prevValue = select.value || '1201';
      const res = await fetch('/api/items');
      const items = await res.json();
      select.innerHTML = items.map(i =>
        `<option value="${i.item_code}" ${i.item_code === prevValue ? 'selected' : ''}>
          ${i.gds_mclsf_nm}
        </option>`
      ).join('');
    }

    // í’ˆì¢… ë“œë¡­ë‹¤ìš´ (ì´ì „ ì„ íƒê°’ ìœ ì§€)
    async function fetchVarieties() {
      const itemCode = document.getElementById('item-select').value;
      const select = document.getElementById('variety-select');
      const prevValue = select.value || '';
      const startWeek = document.getElementById('start-week').value;
      const endWeek = document.getElementById('end-week').value;
      if (!itemCode || !startWeek || !endWeek) return;

      const res = await fetch(
        `/api/varieties?item_code=${itemCode}&start_week=${startWeek}&end_week=${endWeek}`
      );
      const varieties = await res.json();
      select.innerHTML = `<option value="">ì „ì²´</option>` +
        varieties.map(v =>
          `<option value="${v.crop_full_code}" ${v.crop_full_code === prevValue ? 'selected' : ''}>
            ${v.gds_sclsf_nm}
          </option>`
        ).join('');
    }

    // ì‚°ì§€ ë“œë¡­ë‹¤ìš´ (ì´ì „ ì„ íƒê°’ ìœ ì§€)
    async function fetchSanjis() {
      const itemCode = document.getElementById('item-select').value;
      const cropFullCode = document.getElementById('variety-select').value;
      const select = document.getElementById('sanji-select');
      const prevValue = select.value || '';
      const startWeek = document.getElementById('start-week').value;
      const endWeek = document.getElementById('end-week').value;
      if (!itemCode || !startWeek || !endWeek) return;

      let query = `?item_code=${itemCode}&start_week=${startWeek}&end_week=${endWeek}`;
      if (cropFullCode) query += `&crop_full_code=${cropFullCode}`;
      const res = await fetch(`/api/sanjis${query}`);
      const sanjis = await res.json();
      select.innerHTML = '<option value="">ì „ì²´</option>' +
        sanjis.map(s =>
          `<option value="${s.j_sanji_cd}" ${s.j_sanji_cd === prevValue ? 'selected' : ''}>
            ${s.j_sanji_nm}
          </option>`
        ).join('');
    }

    // í…Œì´ë¸”ì— ë°ì´í„° ì¶œë ¥
    async function fetchWeeklyTrade(params) {
      const query = new URLSearchParams(params).toString();
      const res = await fetch(`/api/weekly_trade?${query}`);
      const data = await res.json();
      const tbody = document.querySelector('#result-table tbody');
      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">ë°ì´í„° ì—†ìŒ</td></tr>';
        return;
      }
      tbody.innerHTML = data.map(row => `
        <tr>
          <td>${row.weekno || '-'}</td>
          <td>${row.gds_mclsf_nm || '-'}</td>
          <td>${row.gds_sclsf_nm || '-'}</td>
          <td>${row.grd_nm || '-'}</td>
          <td>${row.j_sanji_nm || '-'}</td>
          <td>${row.unit_tot_qty || '-'}</td>
          <td>${row.avg_price || '-'}</td>
        </tr>
      `).join('');
    }

    // í¼ ê°’ ë³€ê²½ ì´ë²¤íŠ¸ (ì¡°íšŒìš© X)
    document.getElementById('item-select').addEventListener('change', () => {
      fetchVarieties().then(fetchSanjis);
    });
    document.getElementById('variety-select').addEventListener('change', fetchSanjis);
    document.getElementById('start-week').addEventListener('change', () => {
      fetchVarieties().then(fetchSanjis);
    });
    document.getElementById('end-week').addEventListener('change', () => {
      fetchVarieties().then(fetchSanjis);
    });

    // ì¡°íšŒ(Submit) ì‹œ â†’ **ì˜µì…˜ ê°±ì‹  ì—†ì´** ë°ì´í„°ë§Œ ì¶œë ¥
    document.getElementById('filter-form').addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const params = {};
      formData.forEach((value, key) => {
        if (value !== "") params[key] = value;
      });
      fetchWeeklyTrade(params);
    });

    // ì´ˆê¸° ì‹¤í–‰
    async function initPage() {
      const weekRes = await fetch('/api/latest_weeks');
      const { start_week, end_week } = await weekRes.json();
      document.getElementById('start-week').value = start_week;
      document.getElementById('end-week').value = end_week;
      await fetchItems();
      await fetchVarieties();
      await fetchSanjis();
      // í˜ì´ì§€ ë¡œë“œì‹œ ê¸°ë³¸ ë°ì´í„° ì¶œë ¥
      const params = {
        item_code: document.getElementById('item-select').value,
        start_week: start_week,
        end_week: end_week
      };
      fetchWeeklyTrade(params);
    }
    initPage();
  </script>

</body>
</html>
