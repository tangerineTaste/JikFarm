<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì£¼ê°„ ê±°ë˜ ë°ì´í„° ì¡°íšŒ</title>
</head>
<body>
  <h2>ğŸ“Š ì£¼ê°„ ê±°ë˜ ë°ì´í„° ì¡°íšŒ</h2>

  <form id="filter-form">
    <label>í’ˆëª©:
      <select id="item-select" name="item_code" required></select>
    </label>

    <label>í’ˆì¢…:
      <select id="variety-select" name="crop_full_code">
        <option value="">ì „ì²´</option>
      </select>
    </label>

    <label>ë“±ê¸‰:
      <select id="grade-select" name="grade">
        <option value="">ì „ì²´</option>
        <option value="ê³ ">ê³ </option>
        <option value="ì¤‘">ì¤‘</option>
        <option value="ì €">ì €</option>
      </select>
    </label>

    <label>ì‚°ì§€:
      <select id="sanji-select" name="sanji_cd">
        <option value="">ì „ì²´</option>
      </select>
    </label>

    <label>ì‹œì‘ ì£¼ì°¨:
      <input type="text" id="start-week" name="start_week" placeholder="ì˜ˆ: 202410" required>
    </label>
    <label>ì¢…ë£Œ ì£¼ì°¨:
      <input type="text" id="end-week" name="end_week" placeholder="ì˜ˆ: 202423" required>
    </label>

    <button type="submit">ì¡°íšŒ</button>
  </form>

  <hr>

  <table border="1" id="result-table">
    <thead>
      <tr>
        <th>ì£¼ì°¨</th><th>í’ˆëª©</th><th>í’ˆì¢…</th><th>ë“±ê¸‰</th><th>ì‚°ì§€</th><th>ê±°ë˜ëŸ‰(kg)</th><th>í‰ê· ë‹¨ê°€(ì›)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function fetchItems() {
      const res = await fetch('/api/items');
      const items = await res.json();
      const select = document.getElementById('item-select');
      select.innerHTML = items.map(i =>
        `<option value="${i.item_code}" ${i.item_code === '1201' ? 'selected' : ''}>
          ${i.gds_mclsf_nm}
        </option>`
      ).join('');
      fetchVarieties('1201'); // ê¸°ë³¸ í’ˆì¢… ë¡œë“œ
    }

    async function fetchVarieties(itemCode) {
      const res = await fetch(`/api/varieties?item_code=${itemCode}`);
      const varieties = await res.json();
      const select = document.getElementById('variety-select');
      select.innerHTML = `<option value="">ì „ì²´</option>` +
        varieties.map(v => `<option value="${v.crop_full_code}">${v.gds_sclsf_nm}</option>`).join('');
    }

    async function fetchSanjis() {
      const res = await fetch('/api/sanjis');
      const sanjis = await res.json();
      console.log('ì‚°ì§€ option ê°œìˆ˜:', sanjis.length);
      const select = document.getElementById('sanji-select');
      select.innerHTML += sanjis.map(s =>
        `<option value="${s.j_sanji_cd}">${s.j_sanji_nm}</option>`
      ).join('');
    }

    async function fetchLatestWeekRange() {
      const res = await fetch('/api/latest_weeks');
      const { start_week, end_week } = await res.json();
      document.getElementById('start-week').value = start_week;
      document.getElementById('end-week').value = end_week;
      return { start_week, end_week };
    }

    async function fetchWeeklyTrade(params) {
      const query = new URLSearchParams(params).toString();
      const res = await fetch(`/api/weekly_trade?${query}`);
      const data = await res.json();
      const tbody = document.querySelector('#result-table tbody');
      tbody.innerHTML = data.map(row => `
        <tr>
          <td>${row.weekno}</td>
          <td>${row.gds_mclsf_nm}</td>
          <td>${row.gds_sclsf_nm || '-'}</td>
          <td>${row.grd_nm}</td>
          <td>${row.j_sanji_nm}</td>
          <td>${row.unit_tot_qty}</td>
          <td>${row.avg_price}</td>
        </tr>
      `).join('');
    }

    document.getElementById('item-select').addEventListener('change', e => {
      fetchVarieties(e.target.value);
    });

    document.getElementById('filter-form').addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const params = {};
      formData.forEach((value, key) => {
        if (value) params[key] = value;
      });
      fetchWeeklyTrade(params);
    });

    // ì´ˆê¸° ì‹¤í–‰
    async function initPage() {
      await fetchItems();                 // í’ˆëª© ë¨¼ì € ë¡œë“œ
      await fetchSanjis();               // ì‚°ì§€ ë¡œë“œ
      const { start_week, end_week } = await fetchLatestWeekRange();

      // í˜„ì¬ ì„ íƒëœ item_codeë¥¼ í¼ì—ì„œ ê°€ì ¸ì˜¤ê¸°
      const itemCode = document.getElementById('item-select').value;
      fetchVarieties(itemCode);          // í’ˆì¢… ë“œë¡­ë‹¤ìš´ë„ ë™ê¸°í™”

      // ê¸°ë³¸ ë°ì´í„° ìš”ì²­
      fetchWeeklyTrade({
        item_code: itemCode,
        start_week,
        end_week
      });
      }

// ì´ˆê¸° ì‹¤í–‰
initPage();
  </script>
</body>
</html>
